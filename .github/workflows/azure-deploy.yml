name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP: ogsm-platform-rg
  ACR_NAME: ogsmplatformacr
  LOCATION: eastus

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Get ACR login server
        id: acr
        run: |
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer --output tsv)
          echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Build and push backend image using ACR
        run: |
          az acr build --registry ${{ env.ACR_NAME }} --image ogsm-backend:latest ./backend

      - name: Build and push frontend image using ACR
        run: |
          az acr build --registry ${{ env.ACR_NAME }} --image ogsm-frontend:latest ./frontend

      - name: Restart backend web app
        run: |
          az webapp restart --name ogsm-backend-webapp --resource-group ${{ env.RESOURCE_GROUP }}

      - name: Restart frontend web app
        run: |
          az webapp restart --name ogsm-frontend-webapp --resource-group ${{ env.RESOURCE_GROUP }}

      - name: Check deployment status
        run: |
          echo "Backend status:"
          az webapp show --resource-group ${{ env.RESOURCE_GROUP }} --name ogsm-backend-webapp --query state
          echo "Frontend status:"
          az webapp show --resource-group ${{ env.RESOURCE_GROUP }} --name ogsm-frontend-webapp --query state

      - name: Verify backend health
        run: |
          echo "Waiting 30 seconds for apps to restart..."
          sleep 30
          echo "Checking backend health..."
          curl -f https://ogsm-backend-webapp.azurewebsites.net/health || echo "Backend health check failed"
